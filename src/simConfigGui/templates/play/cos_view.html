{% extends "play/base.html" %}

{% block title %}{{ sim_name }} - Prime Minister's Office{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/action_cards.css') }}">

<!-- Main Header -->
<header class="pm-header">
    <div class="header-left">
        <div class="seal">IL</div>
        <div class="header-title">
            <h1>STATE OF ISRAEL - PRIME MINISTER'S OFFICE</h1>
            <p>Crisis Management Console</p>
        </div>
    </div>
    <div class="header-right">
        <div class="status-badge">Turn <strong id="turn-number">{{ turn_number }}</strong></div>
        <div class="status-badge"><span id="game-time">{{ world_state.get('turn_date', 'N/A') }}</span></div>
        <div class="status-badge">Hours: <strong id="hours-elapsed">0</strong></div>
        <div class="phase-badge" id="phase-badge">AWAITING</div>
        <a href="{{ url_for('simulation.view_simulation', name=sim_name) }}" class="btn-exit">Exit</a>
    </div>
</header>

<!-- Main Container -->
<div class="pm-container">
    <!-- Left Sidebar -->
    <aside class="sidebar-left">
        <!-- Document Queue -->
        <div class="panel">
            <div class="panel-header">
                Incoming Documents
                <span class="count" id="doc-count">0</span>
            </div>
            <div class="panel-content">
                <div id="document-queue">
                    <p class="empty-queue">Click "Start Turn" to receive briefing</p>
                </div>
            </div>
        </div>

        <!-- Active Operations -->
        <div class="panel">
            <div class="panel-header">
                Active Operations
                <span class="count" id="ops-count">0</span>
            </div>
            <div class="panel-content">
                <div id="active-operations">
                    <p class="empty-ops">No operations in progress</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- CoS Briefing -->
        <div class="cos-briefing" id="cos-briefing">
            <div class="cos-header">
                <div class="cos-avatar">CoS</div>
                <div class="cos-title">
                    <h2>Chief of Staff Briefing</h2>
                    <p id="briefing-subtitle">Awaiting turn start</p>
                </div>
                <button id="start-turn-btn" class="btn-start" onclick="startTurn()">Start Turn</button>
            </div>
            <div class="cos-narrative" id="cos-narrative">
                <p class="placeholder">Click "Start Turn" to begin the crisis simulation...</p>
            </div>
            <div class="cos-conflicts hidden" id="cos-conflicts">
                <div class="conflict-label">CONFLICT DETECTED</div>
                <div class="conflict-text" id="conflict-text"></div>
            </div>
            <div class="cos-priority hidden" id="cos-priority">
                <div class="priority-label">PRIORITY QUEUE</div>
                <div id="priority-list"></div>
            </div>
        </div>

        <!-- Document Viewer -->
        <div class="document-viewer" id="document-viewer">
            <div class="doc-viewer-header" id="doc-header">
                <h3 id="doc-viewer-title">Select a document</h3>
                <div class="classification-stamp" id="doc-classification">UNCLASSIFIED</div>
            </div>
            <div class="doc-viewer-body" id="doc-viewer-body">
                <div class="select-prompt">
                    <p>Select a document from the queue to view details and take action.</p>
                </div>
            </div>
            <div class="doc-actions hidden" id="doc-actions"></div>
        </div>

        <!-- Meeting Area (hidden by default) -->
        <div class="meeting-area hidden" id="meeting-area">
            <div class="meeting-header">
                <h3>Meeting with <span id="meeting-agent-name"></span></h3>
                <button class="btn-secondary" onclick="endMeeting()">End Meeting (+7h)</button>
            </div>
            <div id="meeting-history" class="meeting-history"></div>
            <div class="meeting-input">
                <input type="text" id="meeting-input" placeholder="Type your message..." onkeypress="handleMeetingKeypress(event)">
                <button class="btn-primary" onclick="sendMeetingMessage()">Send</button>
            </div>
        </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
        <!-- World State -->
        <div class="panel">
            <div class="panel-header">National Status</div>
            <div class="panel-content metrics">
                {% for key, value in world_state.items() %}
                {% if key not in ['fronts', 'turn_date', 'war_declared'] and value is number %}
                <div class="metric-item">
                    <span class="metric-label">{{ key.replace('_', ' ').title() }}</span>
                    <div class="metric-display">
                        <span class="metric-value" id="state-{{ key }}">{{ value }}{% if value <= 100 and value >= 0 %}%{% endif %}</span>
                        {% if value <= 100 and value >= 0 %}
                        <div class="metric-bar">
                            <div class="metric-bar-fill {% if value >= 60 %}good{% elif value >= 30 %}warning{% else %}danger{% endif %}" style="width: {{ value }}%"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Front Status -->
        <div class="panel">
            <div class="panel-header">Front Status</div>
            <div class="panel-content fronts">
                {% for front, status in world_state.get('fronts', {}).items() %}
                <div class="front-item">
                    <span class="front-name">{{ front.title() }}</span>
                    <span class="front-status {{ status.replace('_', '-') }}">{{ status.replace('_', ' ').upper() }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Available Advisors -->
        <div class="panel">
            <div class="panel-header">Request Meeting (+7h)</div>
            <div class="advisor-grid">
                {% for agent in meetable_agents %}
                <button class="advisor-btn" data-agent="{{ agent.name }}" onclick="requestMeeting('{{ agent.name }}')">
                    <span>{{ agent.role[:12] }}{% if agent.role|length > 12 %}...{% endif %}</span>
                    <small>{{ agent.name.replace('_', ' ')[:10] }}</small>
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Proceed Button -->
        <div class="footer-actions">
            <button id="proceed-btn" class="btn-proceed" onclick="proceedToNextTurn()" disabled>
                PROCEED TO NEXT TURN
            </button>
            <p class="proceed-note" id="proceed-note">Start turn to receive briefing</p>
        </div>
    </aside>
</div>

<style>
:root {
    --navy: #1e3a5f;
    --navy-light: #2c5282;
    --gold: #c9a227;
    --cream: #f5f3ef;
    --red-critical: #c53030;
    --orange-high: #dd6b20;
    --green-success: #38a169;
    --gray-600: #4a5568;
    --gray-400: #a0aec0;
    --white: #ffffff;
    --bg: #f7fafc;
    --card-bg: #ffffff;
    --text: #1a202c;
    --text-secondary: #718096;
    --border: #e2e8f0;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

/* Main Header */
.pm-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    color: var(--white);
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.seal {
    width: 44px;
    height: 44px;
    background: var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid var(--white);
    color: var(--navy);
}

.header-title h1 {
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.header-title p {
    font-size: 11px;
    opacity: 0.8;
}

.header-right {
    display: flex;
    gap: 16px;
    align-items: center;
}

.status-badge {
    background: rgba(255,255,255,0.1);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
}

.status-badge strong {
    color: var(--gold);
}

.phase-badge {
    background: var(--red-critical);
    padding: 6px 16px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 11px;
    letter-spacing: 1px;
}

.phase-badge.briefing { background: var(--navy-light); }
.phase-badge.meeting { background: var(--orange-high); }
.phase-badge.decision { background: var(--green-success); }

.btn-exit {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.3);
    color: var(--white);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    text-decoration: none;
}

/* Main Layout */
.pm-container {
    display: grid;
    grid-template-columns: 280px 1fr 300px;
    gap: 16px;
    padding: 16px;
    height: calc(100vh - 68px);
    overflow: hidden;
    background: var(--cream);
}

/* Panels */
.panel {
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 12px;
}

.panel-header {
    background: var(--navy);
    color: var(--white);
    padding: 10px 14px;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header .count {
    background: var(--gold);
    color: var(--navy);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
}

.panel-content {
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
}

/* Left Sidebar */
.sidebar-left {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

/* Document Queue */
.doc-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 6px;
    background: var(--bg);
    border-left: 3px solid transparent;
}

.doc-item:hover { background: #e2e8f0; }
.doc-item.active {
    background: #e2e8f0;
    border-left-color: var(--navy);
}

.doc-urgency {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.doc-urgency.critical { background: var(--red-critical); }
.doc-urgency.high { background: var(--orange-high); }
.doc-urgency.medium { background: #4299e1; }
.doc-urgency.low { background: var(--gray-400); }

.doc-info { flex: 1; min-width: 0; }

.doc-type {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--gray-600);
}

.doc-title {
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.doc-source {
    font-size: 10px;
    color: var(--gray-400);
}

.empty-queue, .empty-ops {
    color: var(--text-secondary);
    font-size: 12px;
    text-align: center;
    padding: 20px;
}

/* Active Operations */
.op-item {
    padding: 10px;
    background: var(--bg);
    border-radius: 6px;
    margin-bottom: 8px;
}

.op-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.op-name {
    font-weight: 600;
    font-size: 11px;
}

.op-category {
    font-size: 9px;
    background: var(--navy);
    color: var(--white);
    padding: 2px 6px;
    border-radius: 4px;
}

.progress-bar {
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4299e1 0%, #48bb78 100%);
    transition: width 0.5s;
}

.op-eta {
    font-size: 10px;
    color: var(--gray-600);
    margin-top: 4px;
}

/* Main Content */
.main-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow: hidden;
}

/* CoS Briefing */
.cos-briefing {
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.cos-header {
    background: linear-gradient(135deg, var(--navy) 0%, #2d3748 100%);
    color: var(--white);
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
}

.cos-avatar {
    width: 40px;
    height: 40px;
    background: var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: var(--navy);
    font-size: 14px;
}

.cos-title { flex: 1; }
.cos-title h2 { font-size: 14px; font-weight: 600; }
.cos-title p { font-size: 11px; opacity: 0.8; }

.btn-start {
    background: var(--gold);
    color: var(--navy);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
}

.btn-start:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.cos-narrative {
    padding: 16px;
    font-size: 13px;
    line-height: 1.6;
    color: #2d3748;
    max-height: 150px;
    overflow-y: auto;
}

.cos-narrative .placeholder {
    color: var(--text-secondary);
    font-style: italic;
}

.cos-conflicts {
    padding: 12px 16px;
    background: #fff5f5;
    border-left: 4px solid var(--red-critical);
}

.conflict-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--red-critical);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.conflict-text {
    font-size: 12px;
    color: #742a2a;
}

.cos-priority {
    padding: 12px 16px;
    background: #f7fafc;
    border-top: 1px solid var(--border);
}

.priority-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.priority-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    font-size: 12px;
    cursor: pointer;
}

.priority-item:hover {
    color: var(--navy);
}

.priority-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
}

.priority-badge.critical { background: var(--red-critical); color: white; }
.priority-badge.high { background: var(--orange-high); color: white; }
.priority-badge.medium { background: #4299e1; color: white; }

/* Document Viewer */
.document-viewer {
    flex: 1;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.doc-viewer-header {
    background: var(--navy);
    color: var(--white);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.doc-viewer-header h3 { font-size: 13px; }

.classification-stamp {
    background: var(--red-critical);
    padding: 3px 10px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: bold;
    letter-spacing: 0.5px;
}

.classification-stamp.confidential { background: #dc3545; }
.classification-stamp.secret { background: #ff6600; }
.classification-stamp.top_secret, .classification-stamp.top-secret { background: #8b0000; }

.doc-viewer-body {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.select-prompt {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px;
}

.doc-letterhead {
    display: flex;
    align-items: center;
    gap: 14px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--navy);
    margin-bottom: 16px;
}

.letterhead-logo {
    width: 50px;
    height: 50px;
    background: var(--navy);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: bold;
    font-size: 16px;
}

.letterhead-info h4 { font-size: 15px; color: var(--navy); }
.letterhead-info p { font-size: 11px; color: var(--gray-600); }

.doc-subject { margin-bottom: 16px; }
.doc-subject label {
    font-size: 10px;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.doc-subject h5 {
    font-size: 14px;
    color: var(--navy);
    margin-top: 4px;
}

.doc-body-text {
    font-size: 13px;
    line-height: 1.7;
    margin-bottom: 20px;
}

.impact-section {
    background: #f7fafc;
    border-radius: 6px;
    padding: 14px;
    margin-bottom: 16px;
}

.impact-section h6 {
    font-size: 10px;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
}

.impact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 10px;
}

.impact-item {
    text-align: center;
    padding: 8px;
    background: var(--white);
    border-radius: 4px;
}

.impact-item .impact-label { font-size: 10px; color: var(--gray-600); }
.impact-item .impact-value { font-size: 16px; font-weight: bold; }
.impact-item .impact-value.positive { color: var(--green-success); }
.impact-item .impact-value.negative { color: var(--red-critical); }

.doc-actions {
    padding: 14px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    background: #f7fafc;
}

.doc-actions .btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-approve { background: var(--green-success); color: white; }
.btn-approve:hover { background: #2f855a; }
.btn-deny { background: var(--gray-600); color: white; }
.btn-deny:hover { background: #2d3748; }
.btn-authorize { background: #3498db; color: white; }
.btn-defer { background: var(--gray-400); color: white; }

/* Meeting Area */
.meeting-area {
    flex: 1;
    background: var(--card-bg);
    padding: 16px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}

.meeting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
}

.meeting-history {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 12px;
}

.meeting-message {
    padding: 10px 14px;
    border-radius: 8px;
    margin-bottom: 8px;
    max-width: 80%;
}

.meeting-message.player {
    background: var(--navy);
    color: white;
    margin-left: auto;
}

.meeting-message.agent {
    background: var(--bg);
}

.meeting-input {
    display: flex;
    gap: 8px;
}

.meeting-input input {
    flex: 1;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
}

.btn-primary {
    background: var(--navy);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary {
    background: var(--gray-400);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
}

/* Right Sidebar */
.sidebar-right {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.panel-content.metrics { padding: 0; }

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
}

.metric-item:last-child { border-bottom: none; }
.metric-label { font-size: 11px; color: var(--gray-600); }

.metric-display {
    display: flex;
    align-items: center;
    gap: 8px;
}

.metric-value { font-weight: 600; font-size: 12px; }
.metric-value.changed-up { color: var(--green-success); }
.metric-value.changed-down { color: var(--red-critical); }

.metric-bar {
    width: 60px;
    height: 5px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.metric-bar-fill { height: 100%; border-radius: 3px; }
.metric-bar-fill.good { background: var(--green-success); }
.metric-bar-fill.warning { background: var(--orange-high); }
.metric-bar-fill.danger { background: var(--red-critical); }

.panel-content.fronts { padding: 0; }

.front-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
}

.front-name { font-size: 12px; font-weight: 500; }

.front-status {
    font-size: 9px;
    padding: 3px 8px;
    border-radius: 10px;
}

.front-status.active-combat { background: #fed7d7; color: #c53030; }
.front-status.tense { background: #feebc8; color: #c05621; }
.front-status.quiet { background: #c6f6d5; color: #276749; }
.front-status.monitoring { background: #e2e8f0; color: #4a5568; }

.advisor-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
    padding: 10px;
}

.advisor-btn {
    padding: 8px 6px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
}

.advisor-btn:hover {
    background: var(--navy);
    color: white;
    border-color: var(--navy);
}

.advisor-btn span { display: block; font-size: 10px; font-weight: 500; }
.advisor-btn small { font-size: 8px; color: var(--gray-400); }
.advisor-btn:hover small { color: rgba(255,255,255,0.7); }
.advisor-btn.met { opacity: 0.5; }

.footer-actions {
    padding: 12px;
    background: var(--card-bg);
    border-radius: 8px;
    text-align: center;
    margin-top: auto;
}

.btn-proceed {
    width: 100%;
    padding: 12px;
    background: var(--navy);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
}

.btn-proceed:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-proceed.enabled {
    background: var(--green-success);
}

.proceed-note {
    font-size: 10px;
    color: var(--gray-600);
    margin-top: 6px;
}

/* Options styling within document viewer */
.options-container {
    margin-top: 16px;
}

.option-item {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.option-item:hover {
    border-color: var(--navy);
}

.option-item.selected {
    border-color: var(--green-success);
    background: #f0fff4;
}

.option-header {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 6px;
}

.option-number {
    font-weight: bold;
    color: var(--navy);
}

.option-text {
    font-size: 13px;
    font-weight: 500;
}

.option-impacts {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.impact-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
}

.impact-badge.positive { background: rgba(56, 161, 105, 0.15); color: var(--green-success); }
.impact-badge.negative { background: rgba(197, 48, 48, 0.15); color: var(--red-critical); }

/* Demands styling */
.demands-container {
    margin-top: 16px;
}

.demand-item {
    background: var(--bg);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
}

.demand-text {
    font-size: 13px;
    margin-bottom: 10px;
}

.demand-buttons {
    display: flex;
    gap: 8px;
}

.demand-buttons .btn {
    padding: 6px 14px;
    font-size: 11px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-agree {
    background: transparent;
    border: 2px solid var(--green-success);
    color: var(--green-success);
}

.btn-agree:hover, .btn-agree.selected {
    background: var(--green-success);
    color: white;
}

.btn-disagree {
    background: transparent;
    border: 2px solid var(--red-critical);
    color: var(--red-critical);
}

.btn-disagree:hover, .btn-disagree.selected {
    background: var(--red-critical);
    color: white;
}

.warning-banner {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 10px 12px;
    margin-top: 12px;
    font-size: 11px;
    color: #856404;
}

.hidden { display: none !important; }
</style>

<script>
const simName = '{{ sim_name }}';
let currentPhase = 'start';
let currentActionItems = [];
let currentDocIndex = -1;
let demandResponses = {};

async function apiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
    };
    if (data) options.body = JSON.stringify(data);
    const response = await fetch(`/play/${simName}/cos${endpoint}`, options);
    return response.json();
}

async function startTurn() {
    const btn = document.getElementById('start-turn-btn');
    btn.disabled = true;
    btn.textContent = 'Processing...';

    try {
        const result = await apiCall('/step', 'POST');

        if (result.success) {
            currentPhase = 'briefing';
            updatePhase('BRIEFING');

            // Update turn info
            if (result.briefing) {
                document.getElementById('turn-number').textContent = result.briefing.turnNumber;
                document.getElementById('game-time').textContent = result.briefing.gameTime;
                document.getElementById('hours-elapsed').textContent = result.briefing.hoursElapsed || 0;
            }

            // Update CoS briefing panel
            if (result.cos_briefing) {
                updateCosBriefing(result.cos_briefing);
            } else if (result.briefing) {
                // Fallback to old format
                document.getElementById('cos-narrative').innerHTML = result.briefing.chiefOfStaffNarrative || 'Briefing in progress...';
            }

            // Update action items
            if (result.action_items && result.action_items.length > 0) {
                currentActionItems = result.action_items;
                updateDocumentQueue(result.action_items);
                document.getElementById('proceed-note').textContent = `Resolve ${result.action_items.length} items to proceed`;
            }

            // Update world state
            if (result.world_state) {
                updateWorldState(result.world_state);
            }

            // Update active operations
            if (result.active_operations) {
                updateActiveOperations(result.active_operations);
            }

            btn.textContent = 'Next Turn';
        } else {
            alert('Error: ' + result.error);
            btn.textContent = 'Start Turn';
        }
    } catch (e) {
        alert('Error: ' + e.message);
        btn.textContent = 'Start Turn';
    }

    btn.disabled = false;
}

function updateCosBriefing(briefing) {
    document.getElementById('briefing-subtitle').textContent = `Turn ${briefing.turnNumber} - ${briefing.gameTime}`;
    document.getElementById('cos-narrative').innerHTML = briefing.chiefOfStaffNarrative || 'Briefing prepared.';

    // Show conflicts
    if (briefing.conflicts && briefing.conflicts.length > 0) {
        document.getElementById('cos-conflicts').classList.remove('hidden');
        document.getElementById('conflict-text').innerHTML = briefing.conflicts
            .map(c => `<strong>${c.agentA}</strong> vs <strong>${c.agentB}</strong>: ${c.description}`)
            .join('<br>');
    } else {
        document.getElementById('cos-conflicts').classList.add('hidden');
    }

    // Show priority queue
    if (briefing.priorityQueue && briefing.priorityQueue.length > 0) {
        document.getElementById('cos-priority').classList.remove('hidden');
        document.getElementById('priority-list').innerHTML = briefing.priorityQueue.map((p, i) => `
            <div class="priority-item" onclick="selectDocument(${i})">
                <span class="priority-badge ${p.urgency}">${p.urgency.toUpperCase()}</span>
                <span>${p.itemType} from ${p.source}</span>
            </div>
        `).join('');
    }
}

function updateDocumentQueue(items) {
    const queue = document.getElementById('document-queue');
    document.getElementById('doc-count').textContent = items.length;

    if (items.length === 0) {
        queue.innerHTML = '<p class="empty-queue">No pending documents</p>';
        return;
    }

    queue.innerHTML = items.map((item, i) => `
        <div class="doc-item ${i === currentDocIndex ? 'active' : ''}" onclick="selectDocument(${i})">
            <div class="doc-urgency ${item.urgency || 'medium'}"></div>
            <div class="doc-info">
                <div class="doc-type">${item.type}</div>
                <div class="doc-title">${item.title}</div>
                <div class="doc-source">${item.source_role || 'Unknown'}</div>
            </div>
        </div>
    `).join('');
}

function selectDocument(index) {
    currentDocIndex = index;
    const item = currentActionItems[index];
    if (!item) return;

    // Update queue selection
    document.querySelectorAll('.doc-item').forEach((el, i) => {
        el.classList.toggle('active', i === index);
    });

    // Render document based on type
    renderDocument(item);
}

function renderDocument(item) {
    const header = document.getElementById('doc-viewer-title');
    const classification = document.getElementById('doc-classification');
    const body = document.getElementById('doc-viewer-body');
    const actions = document.getElementById('doc-actions');

    header.textContent = item.title;
    classification.textContent = (item.classification || 'CONFIDENTIAL').toUpperCase();
    classification.className = 'classification-stamp ' + (item.classification || 'confidential').toLowerCase().replace('_', '-');

    // Build document body based on type
    let bodyHtml = '';
    let actionsHtml = '';

    // Letterhead
    const logoText = (item.source_role || 'DOC').substring(0, 3).toUpperCase();
    bodyHtml += `
        <div class="doc-letterhead">
            <div class="letterhead-logo">${logoText}</div>
            <div class="letterhead-info">
                <h4>${item.source_role || 'Official Document'}</h4>
                <p>${item.type.toUpperCase()} - ${item.id}</p>
            </div>
        </div>
        <div class="doc-subject">
            <label>Subject</label>
            <h5>${item.title}</h5>
        </div>
        <div class="doc-body-text">${item.content}</div>
    `;

    // Type-specific content
    if (item.type === 'approval') {
        // Impacts
        const impacts = item.approval_impacts || {};
        if (Object.keys(impacts).length > 0) {
            bodyHtml += `
                <div class="impact-section">
                    <h6>Projected Impact</h6>
                    <div class="impact-grid">
                        ${Object.entries(impacts).map(([k, v]) => `
                            <div class="impact-item">
                                <div class="impact-label">${k.replace(/_/g, ' ')}</div>
                                <div class="impact-value ${v > 0 ? 'positive' : 'negative'}">${v > 0 ? '+' : ''}${v}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        actionsHtml = `
            <button class="btn btn-approve" onclick="handleApproval('${item.id}', true)">APPROVE</button>
            <button class="btn btn-deny" onclick="handleApproval('${item.id}', false)">DENY</button>
        `;
    } else if (item.type === 'operation') {
        bodyHtml += `
            <div class="impact-section">
                <h6>Operation Details</h6>
                <div class="impact-grid">
                    <div class="impact-item">
                        <div class="impact-label">Category</div>
                        <div class="impact-value">${(item.operation_category || 'INTEL').toUpperCase()}</div>
                    </div>
                    <div class="impact-item">
                        <div class="impact-label">Duration</div>
                        <div class="impact-value">${item.operation_duration || 48}h</div>
                    </div>
                </div>
            </div>
        `;
        if (item.operation_expected_outcome) {
            bodyHtml += `
                <div class="impact-section">
                    <h6>Expected Outcome</h6>
                    <p>${item.operation_expected_outcome}</p>
                </div>
            `;
        }
        actionsHtml = `
            <button class="btn btn-authorize" onclick="authorizeOperation('${item.id}')">AUTHORIZE</button>
            <button class="btn btn-defer" onclick="deferItem('${item.id}')">DEFER</button>
        `;
    } else if (item.type === 'option') {
        const options = item.options || [];
        bodyHtml += `<div class="options-container">`;
        options.forEach((opt, i) => {
            const impactsHtml = Object.entries(opt.impacts || {}).map(([k, v]) => `
                <span class="impact-badge ${v > 0 ? 'positive' : 'negative'}">${k.replace(/_/g, ' ')}: ${v > 0 ? '+' : ''}${v}</span>
            `).join('');
            bodyHtml += `
                <div class="option-item" onclick="selectOption('${item.id}', '${opt.id || i}')">
                    <div class="option-header">
                        <span class="option-number">${i + 1}.</span>
                        <span class="option-text">${opt.text}</span>
                    </div>
                    <div class="option-impacts">${impactsHtml}</div>
                </div>
            `;
        });
        bodyHtml += `</div>`;
        actionsHtml = ''; // Selection is inline
    } else if (item.type === 'demand') {
        const demands = item.demand_items || item.demands || [];
        bodyHtml += `<div class="demands-container">`;
        demands.forEach((d, i) => {
            bodyHtml += `
                <div class="demand-item" data-demand-id="${d.id || i}">
                    <div class="demand-text">${i + 1}. ${d.text}</div>
                    <div class="demand-buttons">
                        <button class="btn btn-agree" onclick="setDemandResponse('${item.id}', '${d.id || i}', 'agree', this)">Agree</button>
                        <button class="btn btn-disagree" onclick="setDemandResponse('${item.id}', '${d.id || i}', 'disagree', this)">Disagree</button>
                    </div>
                </div>
            `;
        });
        bodyHtml += `</div>`;
        if (item.deadline_warning || item.warning_text) {
            bodyHtml += `
                <div class="warning-banner">
                    <span>&#9888;</span>
                    <span>${item.deadline_warning || item.warning_text}</span>
                </div>
            `;
        }
        actionsHtml = `<button class="btn btn-approve" onclick="submitDemandResponses('${item.id}')">SUBMIT RESPONSES</button>`;
    } else {
        // Info type
        actionsHtml = `<button class="btn btn-approve" onclick="acknowledgeInfo('${item.id}')">ACKNOWLEDGED</button>`;
    }

    body.innerHTML = bodyHtml;
    actions.innerHTML = actionsHtml;
    actions.classList.toggle('hidden', !actionsHtml);
}

async function handleApproval(itemId, approved) {
    try {
        const result = await apiCall('/action-item/approval', 'POST', { item_id: itemId, approved });
        if (result.success) {
            removeItem(itemId);
            if (result.world_state) updateWorldState(result.world_state);
            showNotification(approved ? 'Request approved' : 'Request denied', approved ? 'success' : 'warning');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

async function authorizeOperation(itemId) {
    try {
        const result = await apiCall('/action-item/authorize-operation', 'POST', { item_id: itemId });
        if (result.success) {
            removeItem(itemId);
            if (result.operation) {
                addActiveOperation(result.operation);
            }
            showNotification('Operation authorized', 'success');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

async function selectOption(itemId, optionId) {
    try {
        const result = await apiCall('/action-item/option', 'POST', { item_id: itemId, option_id: optionId });
        if (result.success) {
            removeItem(itemId);
            if (result.world_state) updateWorldState(result.world_state);
            showNotification('Option selected', 'success');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

function setDemandResponse(itemId, demandId, response, btn) {
    if (!demandResponses[itemId]) demandResponses[itemId] = {};
    demandResponses[itemId][demandId] = response;

    // Update button states
    const container = btn.closest('.demand-item');
    container.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

async function submitDemandResponses(itemId) {
    const responses = demandResponses[itemId] || {};
    try {
        const result = await apiCall('/action-item/demands', 'POST', { item_id: itemId, responses });
        if (result.success) {
            removeItem(itemId);
            delete demandResponses[itemId];
            if (result.world_state) updateWorldState(result.world_state);
            showNotification('Responses submitted', 'success');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

async function acknowledgeInfo(itemId) {
    try {
        const result = await apiCall('/action-item/acknowledge', 'POST', { item_id: itemId });
        if (result.success) {
            removeItem(itemId);
            showNotification('Acknowledged', 'info');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

async function deferItem(itemId) {
    try {
        const result = await apiCall('/action-item/defer', 'POST', { item_id: itemId });
        if (result.success) {
            removeItem(itemId);
            showNotification('Deferred to next turn', 'info');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

function removeItem(itemId) {
    currentActionItems = currentActionItems.filter(i => i.id !== itemId);
    updateDocumentQueue(currentActionItems);

    // Clear document viewer if current item was removed
    if (currentActionItems.length === 0) {
        document.getElementById('doc-viewer-body').innerHTML = '<div class="select-prompt"><p>All documents processed. Click "Next Turn" to continue.</p></div>';
        document.getElementById('doc-actions').classList.add('hidden');
        document.getElementById('proceed-btn').disabled = false;
        document.getElementById('proceed-btn').classList.add('enabled');
        document.getElementById('proceed-note').textContent = 'Ready to proceed';
    } else if (currentDocIndex >= currentActionItems.length) {
        selectDocument(0);
    } else {
        selectDocument(currentDocIndex);
    }
    document.getElementById('proceed-note').textContent = currentActionItems.length > 0
        ? `Resolve ${currentActionItems.length} items to proceed`
        : 'Ready to proceed';
}

function updateActiveOperations(operations) {
    const container = document.getElementById('active-operations');
    document.getElementById('ops-count').textContent = operations.length;

    if (operations.length === 0) {
        container.innerHTML = '<p class="empty-ops">No operations in progress</p>';
        return;
    }

    container.innerHTML = operations.map(op => `
        <div class="op-item">
            <div class="op-header">
                <span class="op-name">${op.codename || op.name}</span>
                <span class="op-category">${(op.category || 'INTEL').toUpperCase()}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${op.progress_percent || 0}%"></div>
            </div>
            <div class="op-eta">${Math.round(op.progress_percent || 0)}% | ETA: ${op.eta_hours || '?'}h</div>
        </div>
    `).join('');
}

function addActiveOperation(op) {
    const ops = document.getElementById('active-operations');
    const count = parseInt(document.getElementById('ops-count').textContent) + 1;
    document.getElementById('ops-count').textContent = count;

    if (ops.querySelector('.empty-ops')) {
        ops.innerHTML = '';
    }

    ops.innerHTML += `
        <div class="op-item">
            <div class="op-header">
                <span class="op-name">${op.codename || op.name}</span>
                <span class="op-category">${(op.category || 'INTEL').toUpperCase()}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="op-eta">0% | ETA: ${op.duration_hours || '?'}h</div>
        </div>
    `;
}

function updatePhase(phase) {
    const badge = document.getElementById('phase-badge');
    badge.textContent = phase;
    badge.className = 'phase-badge ' + phase.toLowerCase();
}

function updateWorldState(state) {
    Object.entries(state).forEach(([key, value]) => {
        const el = document.getElementById(`state-${key}`);
        if (el && typeof value === 'number') {
            const oldValue = parseInt(el.textContent);
            const isPercent = value <= 100 && value >= 0;
            el.textContent = value + (isPercent ? '%' : '');

            if (value > oldValue) {
                el.classList.add('changed-up');
                setTimeout(() => el.classList.remove('changed-up'), 2000);
            } else if (value < oldValue) {
                el.classList.add('changed-down');
                setTimeout(() => el.classList.remove('changed-down'), 2000);
            }
        }
    });

    if (state.turn_date) {
        document.getElementById('game-time').textContent = state.turn_date;
    }
}

async function requestMeeting(agentName) {
    try {
        const result = await apiCall('/meeting/start', 'POST', { agent_name: agentName });
        if (result.success) {
            showMeeting(result.meeting);
            updatePhase('MEETING');
            document.querySelector(`.advisor-btn[data-agent="${agentName}"]`).classList.add('met');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

function showMeeting(meeting) {
    document.getElementById('meeting-agent-name').textContent = meeting.agentRole;
    document.getElementById('cos-briefing').classList.add('hidden');
    document.getElementById('document-viewer').classList.add('hidden');
    document.getElementById('meeting-area').classList.remove('hidden');
    renderMeetingHistory(meeting.history);
    document.getElementById('meeting-input').focus();
}

function renderMeetingHistory(history) {
    const el = document.getElementById('meeting-history');
    el.innerHTML = history.map(msg => `
        <div class="meeting-message ${msg.role}">
            ${msg.content}
        </div>
    `).join('');
    el.scrollTop = el.scrollHeight;
}

async function sendMeetingMessage() {
    const input = document.getElementById('meeting-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.disabled = true;

    try {
        const result = await apiCall('/meeting/message', 'POST', { message });
        if (result.success) {
            renderMeetingHistory(result.meeting.history);

            // If new action items were parsed, add them
            if (result.action_items && result.action_items.length > 0) {
                currentActionItems = [...currentActionItems, ...result.action_items];
                updateDocumentQueue(currentActionItems);
            }
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }

    input.disabled = false;
    input.focus();
}

function handleMeetingKeypress(event) {
    if (event.key === 'Enter') sendMeetingMessage();
}

async function endMeeting() {
    try {
        const result = await apiCall('/meeting/end', 'POST');
        if (result.success) {
            document.getElementById('meeting-area').classList.add('hidden');
            document.getElementById('cos-briefing').classList.remove('hidden');
            document.getElementById('document-viewer').classList.remove('hidden');
            updatePhase('BRIEFING');
            if (result.world_state) updateWorldState(result.world_state);
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

async function proceedToNextTurn() {
    if (currentActionItems.length > 0) {
        if (!confirm(`You have ${currentActionItems.length} unresolved items. Proceed anyway?`)) {
            return;
        }
    }
    document.getElementById('proceed-btn').disabled = true;
    document.getElementById('proceed-btn').classList.remove('enabled');
    await startTurn();
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#38a169' : type === 'error' ? '#c53030' : type === 'warning' ? '#dd6b20' : '#3182ce'};
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
