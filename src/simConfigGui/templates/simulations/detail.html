{% extends "base.html" %}

{% block title %}{{ sim_name }}{% endblock %}

{% block content %}
<h1>Simulation: {{ sim_name }}</h1>

<div class="actions refresh-btn">
    <a href="{{ url_for('play.play_view', sim_name=sim_name) }}" class="btn btn-success" style="font-weight: bold;">Play Simulation</a>
    <a href="{{ url_for('play.cos_view', sim_name=sim_name) }}" class="btn btn-primary" style="font-weight: bold;">CoS Mode</a>
    <button onclick="refreshStats('{{ sim_name }}')" class="btn btn-secondary">Refresh</button>
    <a href="{{ url_for('agents.list_agents_view', sim_name=sim_name) }}" class="btn">Manage Agents</a>
    <a href="{{ url_for('events.events_page', sim_name=sim_name) }}" class="btn">Events</a>
    <a href="{{ url_for('simulation.view_pipeline', name=sim_name) }}" class="btn">Pipeline Debug</a>
    <a href="{{ url_for('testing.testing_page', sim_name=sim_name) }}" class="btn">Run Tests</a>
    <a href="{{ url_for('simulation.edit_state', name=sim_name) }}" class="btn">Edit State</a>
    <form action="{{ url_for('simulation.delete_simulation_view', name=sim_name) }}" method="POST" style="display:inline">
        <button type="submit" class="btn btn-danger" onclick="return confirmDelete('Delete simulation {{ sim_name }}?')">Delete Simulation</button>
    </form>
</div>

<div class="grid">
    <div class="card stat-card">
        <div class="value">{{ sim.agents | length }}</div>
        <div class="label">Agents</div>
    </div>
    <div class="card stat-card">
        <div class="value">{{ sim.turnCount }}</div>
        <div class="label">Turns</div>
    </div>
    <div class="card stat-card">
        <form action="{{ url_for('simulation.toggle_test_mode', name=sim_name) }}" method="POST" style="margin:0">
            <button type="submit" class="btn {{ 'btn-warning' if sim.isTestMode else 'btn-success' }}" style="font-size: 1.2rem; padding: 0.5rem 1rem;">
                {{ "MOCK" if sim.isTestMode else "REAL" }}
            </button>
        </form>
        <div class="label">LLM Mode (click to toggle)</div>
    </div>
    <div class="card stat-card">
        <form action="{{ url_for('simulation.toggle_cache', name=sim_name) }}" method="POST" style="margin:0; display:inline">
            <button type="submit" class="btn {{ 'btn-success' if sim.isCacheEnabled else 'btn-secondary' }}" style="font-size: 1.2rem; padding: 0.5rem 1rem;">
                {{ "ON" if sim.isCacheEnabled else "OFF" }}
            </button>
        </form>
        <form action="{{ url_for('simulation.clear_cache', name=sim_name) }}" method="POST" style="margin:0; display:inline">
            <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" onclick="return confirm('Clear all cached responses?')">Clear</button>
        </form>
        <div class="label">Cache</div>
    </div>
</div>

<div class="card">
    <h2>Agents</h2>
    {% if sim.agents %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Role</th>
                <th>Model</th>
                <th>Controlled By</th>
            </tr>
        </thead>
        <tbody>
            {% for agent in sim.agents %}
            <tr>
                <td>{{ agent.name }}</td>
                <td>{{ agent.role }}</td>
                <td>{{ agent.model }}</td>
                <td>{{ agent.controlledBy }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No agents registered.</p>
        <p><a href="{{ url_for('agents.add_agent_view', sim_name=sim_name) }}" class="btn btn-success">Add First Agent</a></p>
    </div>
    {% endif %}
</div>

<div class="card">
    <h2>World State</h2>
    <pre>{{ sim.worldState | tojson(indent=2) }}</pre>
</div>

<div class="card">
    <h2>Statistics</h2>
    <div id="sim-stats">
        <pre>{{ sim.stats | tojson(indent=2) }}</pre>
    </div>
</div>
{% endblock %}
